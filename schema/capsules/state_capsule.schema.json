{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://companion-harness.dev/schema/capsules/state_capsule.schema.json",
  "title": "STATE Capsule",
  "description": "Authoritative, identity-neutral system state capsule for companion-harness.",
  "type": "object",
  "required": [
    "capsule_type",
    "capsule_version",
    "capsule_id",
    "created_at",
    "state"
  ],
  "additionalProperties": false,

  "properties": {
    "capsule_type": {
      "const": "STATE"
    },

    "capsule_version": {
      "type": "string",
      "pattern": "^v[0-9]+$",
      "description": "Capsule schema version."
    },

    "capsule_id": {
      "type": "string",
      "description": "Opaque, unique capsule identifier."
    },

    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 timestamp of capsule creation."
    },

    "hash": {
      "type": "string",
      "description": "Deterministic hash of the canonicalized capsule. Computed externally.",
      "minLength": 1
    },

    "state": {
      "type": "object",
      "required": [
        "session",
        "environment",
        "companion"
      ],
      "additionalProperties": false,

      "properties": {
        "session": {
          "type": "object",
          "required": [
            "session_id",
            "phase"
          ],
          "additionalProperties": false,

          "properties": {
            "session_id": {
              "type": "string",
              "description": "Opaque session identifier."
            },

            "phase": {
              "type": "string",
              "enum": [
                "init",
                "active",
                "recovering"
              ],
              "description": "Lifecycle phase of the session."
            },

            "mode": {
              "type": "string",
              "description": "Declarative session mode. No behavioral enforcement."
            }
          }
        },

        "environment": {
          "type": "object",
          "required": [
            "active_ids"
          ],
          "additionalProperties": false,

          "properties": {
            "active_ids": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "minItems": 1,
              "description": "Identifiers of active environment priming profiles."
            },

            "versions": {
              "type": "object",
              "additionalProperties": {
                "type": "string"
              },
              "description": "Optional mapping of environment IDs to version strings."
            }
          }
        },

        "companion": {
          "type": "object",
          "required": [
            "present",
            "bound"
          ],
          "additionalProperties": false,

          "properties": {
            "present": {
              "type": "boolean",
              "description": "Whether a companion is present in the session."
            },

            "bound": {
              "type": "boolean",
              "description": "Whether a companion identity is bound. This does not imply continuity."
            }
          }
        },

        "capabilities": {
          "type": "object",
          "additionalProperties": {
            "type": "boolean"
          },
          "description": "Optional declarative system capability flags."
        }
      }
    }
  }
}
